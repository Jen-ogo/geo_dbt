version: 2

models:
  - name: road_segments
    description: >
      Canonical road segments (ways) from OSM-derived ROADS source.
      Filters out non-drivable / non-relevant highway classes and restricted/private access.
      Enriches with key attributes (oneway, lanes, maxspeed, bridge/tunnel/layer) and
      geometry as GEOGRAPHY (WGS84) plus debug WKT.
      Deduplicated by osm_id (latest load_ts/source_file wins).

    tests:
      - rowcount_gt_0:
          config:
            name: road_segments__rowcount_gt_0

    columns:
      - name: feature_id
        description: "Stable feature key for ways: 'W<osm_id>'."
        tests: [not_null, unique]

      - name: osm_id
        description: "OSM way id."
        tests: [not_null, unique]

      - name: highway
        description: "OSM highway classification (expected non-null after filtering)."
        tests: [not_null]

      - name: name
        description: "OSM name tag (nullable)."

      - name: ref
        description: "Road reference (tags:ref). Nullable."

      - name: access_raw
        description: "Raw access indicator from tags (motorcar/motor_vehicle/vehicle/access). Nullable."

      - name: service
        description: "Service road subtype (tags:service). Nullable."

      - name: oneway_raw
        description: >
          Raw oneway tag normalized to lowercase (default 'no').
          Note: source can contain many variants; we validate the derived boolean `oneway`.
        tests: [not_null]

      - name: oneway
        description: "Boolean oneway flag derived from oneway_raw."
        tests: [not_null]

      - name: lanes
        description: "Parsed number of lanes (nullable if missing/unparseable)."
        tests:
          - non_negative:
              column_name: lanes
              config:
                name: road_segments__lanes_non_negative

      - name: surface
        description: "Road surface (tags:surface). Nullable."

      - name: lit
        description: "Boolean lit flag derived from tags:lit."
        tests: [not_null]

      - name: bridge
        description: "Boolean bridge flag derived from tags:bridge."
        tests: [not_null]

      - name: tunnel
        description: "Boolean tunnel flag derived from tags:tunnel."
        tests: [not_null]

      - name: layer
        description: "Numeric layer (default 0 when missing/unparseable)."

      - name: maxspeed_raw
        description: "Raw maxspeed tag string. Nullable."

      - name: maxspeed_kph
        description: "Parsed maxspeed normalized to km/h (mph converted when detected). Nullable."
        tests:
          - non_negative:
              column_name: maxspeed_kph
              config:
                name: road_segments__maxspeed_kph_non_negative

      - name: geog
        description: "Road geometry as Snowflake GEOGRAPHY (WGS84)."
        tests: [not_null]

      - name: geom_wkt_4326
        description: "WKT representation of geog (debug/inspection)."
        tests:
          - not_null
          - wkt_not_empty:
              column_name: geom_wkt_4326
              config:
                name: road_segments__geom_wkt_4326_not_empty
          - wkt_prefix_any:
              column_name: geom_wkt_4326
              prefixes: ["LINESTRING", "MULTILINESTRING"]
              config:
                name: road_segments__geom_wkt_4326_prefix_line

      - name: region_code
        description: "Region/country code from ingestion (e.g., poland, germany)."
        tests: [not_null]

      - name: source_file
        description: "Source file path for lineage/debug."
        tests: [not_null]

      - name: load_ts
        description: "Ingestion/load timestamp used for deduplication."
        tests: [not_null]