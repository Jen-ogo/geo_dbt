version: 2

models:
  - name: lau_degurba
    description: >
      SILVER.LAU_DEGURBA â€” Eurostat LAU polygons with DEGURBA classification.
      Region attribution is derived via spatial join to SILVER.ADMIN_AREAS
      using ONLY administrative boundaries (admin_level=4, boundary='administrative'),
      matched by LAU polygon centroid.

      Geometry is stored as GEOGRAPHY with debug WKT; invalid geometries are not "fixed" in SILVER,
      only flagged via is_valid.

    tests:
      - rowcount_gt_0:
          config: { name: lau_degurba__rowcount_gt_0 }

      - not_empty:
          config: { name: lau_degurba__not_empty }

      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: [cntr_code, lau_id, year]
          config: { name: lau_degurba__uk_cntr_lau_year }

    columns:
      - name: feature_id
        description: "Stable synthetic key: LAU:<cntr_code>:<lau_id>:<year>"
        tests: [not_null, unique]

      - name: cntr_code
        tests: [not_null]

      - name: lau_id
        tests: [not_null]

      - name: year
        tests: [not_null]

      - name: degurba
        description: "DEGURBA class (1=city, 2=towns/suburbs, 3=rural)."
        tests:
          - values_in_or_null:
              arguments:
                column_name: degurba
                values: [1, 2, 3]
              config: { name: lau_degurba__degurba_allowed_1_2_3_or_null }

      - name: region_code
        description: "Derived from admin_areas (admin_level=4, administrative boundary). Nullable if no match yet."

      - name: region
        description: "Derived from admin_areas (admin_level=4, administrative boundary). Nullable if no match yet."

      - name: geog
        description: "LAU polygon as Snowflake GEOGRAPHY (WGS84)."
        tests:
          - not_null
          - geog_is_polygonal:
              column_name: geog
              config: { name: lau_degurba__geog_is_polygonal }

      - name: geom_wkt_4326
        description: "WKT representation of GEOGRAPHY (debug/inspection)."
        tests:
          - not_null
          - wkt_not_empty:
              column_name: geom_wkt_4326
              config: { name: lau_degurba__geom_wkt_not_empty }
          - wkt_prefix_any:
              column_name: geom_wkt_4326
              prefixes: ["POLYGON", "MULTIPOLYGON"]
              config: { name: lau_degurba__geom_wkt_prefix_polygonal }

      - name: is_valid
        description: "ST_ISVALID(geog). Used for monitoring; invalid geometries are not fixed in SILVER."

      - name: source_file
        tests: [not_null]

      - name: load_ts
        tests: [not_null]