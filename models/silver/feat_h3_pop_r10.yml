version: 2

models:
  - name: feat_h3_pop_r10
    description: >
      Population features on H3 resolution 10 derived from Eurostat Census Grid 2021 (1km).
      Each 1km grid cell polygon is polyfilled into H3 R10 cells and population/employment
      metrics are allocated proportionally to the intersection area (area-weighted allocation).
      This avoids the "centroid-only" artifact (too few hexes ~70k) and produces a dense,
      analysis-ready H3 grid for populated areas.
      Grain: (region_code, h3_r10, admin4_osm_id).

    tests:
      - rowcount_gt_0:
          config:
            name: feat_h3_pop_r10__rowcount_gt_0

      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: [region_code, h3_r10, admin4_osm_id]
          config:
            name: feat_h3_pop_r10__uk_region_h3_admin4

      # shares sanity (WARN on any, ERROR only if it explodes)
      - dbt_utils.expression_is_true:
          arguments:
            expression: "share_emp is null or (share_emp >= 0 and share_emp <= 1)"
          config:
            name: feat_h3_pop_r10__share_emp_0_1
            severity: warn
            warn_if: "> 0"
            error_if: ">= 1000"

      - dbt_utils.expression_is_true:
          arguments:
            expression: "share_age_lt15 is null or (share_age_lt15 >= 0 and share_age_lt15 <= 1)"
          config:
            name: feat_h3_pop_r10__share_age_lt15_0_1
            severity: warn
            warn_if: "> 0"
            error_if: ">= 1000"

    columns:
      - name: region_code
        description: "Region/country code (from admin4 attribution; e.g. poland, germany)."
        tests:
          - not_null:
              config:
                name: feat_h3_pop_r10__region_code_not_null

      - name: h3_r10
        description: "H3 cell index at resolution 10."
        tests:
          - not_null:
              config:
                name: feat_h3_pop_r10__h3_r10_not_null
          - is_h3_hex:
              config:
                name: feat_h3_pop_r10__h3_r10_is_hex

      - name: cell_area_m2
        description: "H3 cell area (mÂ²) computed from H3 boundary."
        tests:
          - not_null
          - num_gt_0:
              config:
                name: feat_h3_pop_r10__cell_area_m2_gt_0

      - name: cell_wkt_4326
        description: "H3 cell boundary as WKT (EPSG:4326) for debug/inspection."
        tests:
          - not_null:
              config:
                name: feat_h3_pop_r10__cell_wkt_4326_not_null
          - wkt_not_empty:
              config:
                name: feat_h3_pop_r10__cell_wkt_not_empty
          - wkt_prefix_any:
              prefixes: ["POLYGON(", "MULTIPOLYGON("]
              config:
                name: feat_h3_pop_r10__cell_wkt_polygonal

      - name: cell_center_wkt_4326
        description: "H3 cell center point as WKT (EPSG:4326) for debug/inspection."
        tests:
          - not_null:
              config:
                name: feat_h3_pop_r10__cell_center_wkt_4326_not_null
          - wkt_not_empty:
              config:
                name: feat_h3_pop_r10__cell_center_wkt_not_empty
          - wkt_prefix_any:
              prefixes: ["POINT("]
              config:
                name: feat_h3_pop_r10__cell_center_wkt_point

      - name: admin4_osm_id
        description: "Admin level 4 OSM id assigned at grid attribution step."
        tests:
          - not_null:
              config:
                name: feat_h3_pop_r10__admin4_osm_id_not_null

      - name: admin4_name
        description: "Admin level 4 name."

      - name: pop_total
        description: "Area-weighted total population allocated to the H3 cell."
        tests:
          - non_negative:
              config:
                name: feat_h3_pop_r10__pop_total_non_negative

      - name: pop_male
        description: "Area-weighted male population allocated to the H3 cell."
        tests:
          - non_negative:
              config:
                name: feat_h3_pop_r10__pop_male_non_negative

      - name: pop_female
        description: "Area-weighted female population allocated to the H3 cell."
        tests:
          - non_negative:
              config:
                name: feat_h3_pop_r10__pop_female_non_negative

      - name: pop_age_lt15
        description: "Area-weighted population age <15 allocated to the H3 cell."
        tests:
          - non_negative:
              config:
                name: feat_h3_pop_r10__pop_age_lt15_non_negative

      - name: pop_age_1564
        description: "Area-weighted population age 15-64 allocated to the H3 cell."
        tests:
          - non_negative:
              config:
                name: feat_h3_pop_r10__pop_age_1564_non_negative

      - name: pop_age_ge65
        description: "Area-weighted population age 65+ allocated to the H3 cell."
        tests:
          - non_negative:
              config:
                name: feat_h3_pop_r10__pop_age_ge65_non_negative

      - name: emp_total
        description: "Area-weighted employed population allocated to the H3 cell."
        tests:
          - non_negative:
              config:
                name: feat_h3_pop_r10__emp_total_non_negative

      - name: share_age_ge65
        tests:
          - num_between_or_null:
              min_value: 0
              max_value: 1
              config:
                name: feat_h3_pop_r10__share_age_ge65_0_1_warn
                severity: warn
                warn_if: "> 0"
                error_if: ">= 1000"


      - name: share_age_lt15
        description: "pop_age_lt15 / pop_total within the H3 cell (0..1)."
        tests:
          - num_between_or_null:
              min_value: 0
              max_value: 1
              config:
                name: feat_h3_pop_r10__share_age_lt15_0_1_warn
                severity: warn
                warn_if: "> 0"
                error_if: ">= 1000"


      - name: share_emp
        description: "emp_total / pop_total within the H3 cell (0..1)."
        tests:
          - num_between_or_null:
              min_value: 0
              max_value: 1
              config:
                name: feat_h3_pop_r10__share_emp_0_1_warn
                severity: warn
                warn_if: "> 0"
                error_if: ">= 1000"

      - name: grid_cells_cnt
        description: "Number of 1km grid cells contributing (distinct grid_id) to this H3 cell."
        tests:
          - non_negative:
              config:
                name: feat_h3_pop_r10__grid_cells_cnt_non_negative

      - name: last_load_ts
        description: "Latest load timestamp observed in contributing 1km cells."
        tests:
          - not_null:
              config:
                name: feat_h3_pop_r10__last_load_ts_not_null