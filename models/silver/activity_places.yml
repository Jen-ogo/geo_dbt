version: 2

models:
  - name: activity_places
    description: >
      Canonical, cleaned and deduplicated OSM activity/building geometries from BRONZE.BUILDINGS_ACTIVITY.
      No whitelist/blacklist filtering here. Downstream feature marts (H3 R7/R10)
      will do domain filtering and join to H3 dims.
      Grain: (region_code, region, feature_id) latest by load_ts then source_file.

    tests:
      - rowcount_gt_0:
          config:
            name: activity_places__rowcount_gt_0

      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: [region_code, region, feature_id]
          config:
            name: activity_places__uk_region_region_feature

      - osm_id_or_way_id_present:
          config:
            name: activity_places__osm_id_or_way_id_present

      - dbt_utils.expression_is_true:
          expression: "region_code is not null and trim(region_code) <> ''"
          config:
            name: activity_places__region_code_not_empty

      - dbt_utils.expression_is_true:
          expression: "region is not null and trim(region) <> ''"
          config:
            name: activity_places__region_not_empty

      - dbt_utils.expression_is_true:
          expression: "(geom_wkt_4326 is null) or (geog is not null)"
          config:
            name: activity_places__geog_present_when_wkt_present

      - dbt_utils.expression_is_true:
          expression: >
            geom_wkt_4326 ilike 'POLYGON(%'
            or geom_wkt_4326 ilike 'MULTIPOLYGON(%'
            or geom_wkt_4326 ilike 'POINT(%'
            or geom_wkt_4326 ilike 'LINESTRING(%'
          config:
            name: activity_places__wkt_has_geometry_prefix

    columns:
      - name: feature_id
        description: "Stable feature id: 'N' || osm_id or 'W' || osm_way_id."
        tests:
          - not_null

      - name: osm_id
        description: "OSM node id if originating from node; nullable otherwise."

      - name: osm_way_id
        description: "OSM way id if originating from way; nullable otherwise."

      - name: name
        description: "OSM name tag (empty -> NULL)."

      - name: name_en
        description: "OSM name:en from tags JSON (if present)."

      - name: activity_class
        description: "High-level bucket: amenity/shop/office/tourism/leisure/sport/craft/building."
        tests:
          - not_null
          - values_in_or_null:
              column_name: activity_class
              values: ['amenity','shop','office','tourism','leisure','sport','craft','building']
              config:
                name: activity_places__activity_class_allowed

      - name: activity_type_lc
        description: "Lowercased activity type from the first non-null relevant tag."
        tests:
          - not_null

      - name: building_type
        description: "Lowercased building tag value (if present)."

      - name: building_levels
        description: "Parsed building:levels (default 1 if missing)."
        tests:
          - not_null
          - non_negative:
              column_name: building_levels
              config:
                name: activity_places__building_levels_non_negative

      - name: operator_name
        description: "Coalesced operator/network/brand if present."

      - name: opening_hours
        description: "Opening hours tag if present."

      - name: geog
        description: "Snowflake GEOGRAPHY parsed from raw WKT."
        tests:
          - not_null

      - name: geom_wkt_4326
        description: "Debug WKT derived from GEOGRAPHY (EPSG:4326)."
        tests:
          - not_null
          - wkt_not_empty:
              column_name: geom_wkt_4326
              config:
                name: activity_places__wkt_not_empty

      - name: centroid_geog
        description: "Centroid point of the feature GEOGRAPHY."

      - name: region_code
        description: "Country/region code (lowercased)."
        tests:
          - not_null

      - name: region
        description: "Region string (e.g., voivodeship/state)."
        tests:
          - not_null

      - name: source_file
        description: "Source file path for lineage."
        tests:
          - not_null

      - name: load_ts
        description: "Load timestamp used for dedup ordering."
        tests:
          - not_null

      - name: tags
        description: "Parsed tags JSON (from other_tags)."

      - name: other_tags_raw
        description: "Raw other_tags string."