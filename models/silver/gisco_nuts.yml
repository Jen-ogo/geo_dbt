version: 2

models:
  - name: gisco_nuts
    description: >
      GISCO NUTS boundaries (SILVER). Source: BRONZE.GISCO_NUTS.
      Deduplicated by (level, cntr_code, nuts_id, year, scale, crs) keeping the latest
      by (load_ts desc, source_file desc).
      Geometry is stored as:
        - geom_wkt_4326 (STRING, raw WKT from source)
        - geog (GEOGRAPHY, parsed via strict/allow fallback in the model).
      Expected geometry type: polygonal (POLYGON/MULTIPOLYGON).

    tests:
      - rowcount_gt_0:
          config:
            name: gisco_nuts__rowcount_gt_0

    columns:
      - name: feature_id
        description: "Stable key: NUTS:<year>:<scale>:<crs>:<level>:<nuts_id>."
        tests:
          - not_null
          - unique

      - name: nuts_id
        description: "NUTS identifier (e.g., PL21, DE60)."
        tests:
          - not_null

      - name: cntr_code
        description: "Country code (e.g., PL, DE)."
        tests:
          - not_null

      - name: name_latn
        description: "Latin name from GISCO (nullable)."

      - name: levl_code
        description: "NUTS level code from GISCO (nullable; informational)."

      - name: level
        description: "NUTS level as integer (expected 0..3)."
        tests:
          - not_null
          - values_in_or_null:
              arguments:
                column_name: level
                values: ['0', '1', '2', '3']
              config:
                name: gisco_nuts__level_in_0_1_2_3

      - name: year
        description: "Reference year of the GISCO release."
        tests:
          - not_null

      - name: scale
        description: "Source scale label (e.g., 01M/03M)."
        tests:
          - not_null

      - name: crs
        description: "CRS identifier from source metadata (string)."
        tests:
          - not_null

      - name: geom_wkt_4326
        description: "Raw WKT (EPSG:4326) from source, stored as STRING."
        tests:
          - not_null
          - wkt_not_empty:
              arguments:
                column_name: geom_wkt_4326
              config:
                name: gisco_nuts__geom_wkt_not_empty
          - wkt_prefix_in:
              arguments:
                column_name: geom_wkt_4326
                prefixes: ['POLYGON(', 'MULTIPOLYGON(']
              config:
                name: gisco_nuts__geom_wkt_polygonal_prefix

      - name: geog
        description: "Parsed GEOGRAPHY (coalesce strict/allow)."
        tests:
          - not_null
          - geog_is_polygonal:
              arguments:
                column_name: geog
              config:
                name: gisco_nuts__geog_is_polygonal

      - name: geom
        description: "Parsed GEOMETRY (TRY_TO_GEOMETRY) for debug/interop (nullable)."

      - name: source_file
        description: "Source file path for lineage/debug."
        tests:
          - not_null

      - name: load_ts
        description: "Ingestion/load timestamp used for deduplication."
        tests:
          - not_null