# models/gold/feat_h3_poi_points_r10.yml
version: 2

models:
  - name: feat_h3_poi_points_r10
    description: >
      GOLD.FEAT_H3_POI_POINTS_R10 — compact POI (points) intensity features on the H3 resolution 10 grid.

      Source & method
      - Built from SILVER.POI_POINTS (OSM-derived POI nodes, canonicalized & deduplicated in SILVER).
      - Each POI point is assigned to an H3 cell via h3_point_to_cell_string(geog, 10).
      - H3 cell geometry/debug columns come from SILVER.DIM_H3_R10_CELLS.

      Grain
      - (region_code, h3_r10) — exactly one row per H3 r10 cell per region_code.

      What is inside
      - Total POI intensity: `poi_points_cnt`, plus diversity metrics (`poi_classes_cnt`, `poi_types_cnt`).
      - Class breakdown counts (amenity/shop/tourism/…).
      - EV-relevant landmark counters (parking / mobility services / retail core / food / lodging / health).
      - Normalized densities per km² (hex area) for easy cross-area comparisons.

      Data-quality philosophy (GOLD)
      - Strict on structural constraints: keys, H3 format, WKT non-empty/prefix.
      - Metric sanity is mostly non_negative; business outliers are monitored, not over-rejected.

    tests:
      - rowcount_gt_0:
          config:
            name: feat_h3_poi_points_r10__rowcount_gt_0

      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: [region_code, h3_r10]
          config:
            name: feat_h3_poi_points_r10__uk_region_h3

    columns:
      - name: region_code
        description: "Region/country code used across the project (e.g. poland, germany)."
        tests: [not_null]

      - name: h3_r10
        description: "H3 cell index at resolution 10."
        tests:
          - not_null
          - is_h3_hex:
              config:
                name: feat_h3_poi_points_r10__h3_r10_is_hex

      - name: cell_area_m2
        description: "Area of the H3 cell polygon (m²)."
        tests:
          - not_null
          - non_negative:
              config:
                name: feat_h3_poi_points_r10__cell_area_m2_non_negative

      - name: cell_wkt_4326
        description: "H3 cell boundary as WKT POLYGON (debug/inspection)."
        tests:
          - not_null
          - wkt_not_empty:
              config:
                name: feat_h3_poi_points_r10__cell_wkt_not_empty
          - wkt_prefix_any:
              arguments:
                prefixes: ["POLYGON", "MULTIPOLYGON"]
              config:
                name: feat_h3_poi_points_r10__cell_wkt_prefix_polygon

      - name: cell_center_wkt_4326
        description: "H3 cell center point as WKT POINT (debug/inspection)."
        tests:
          - not_null
          - wkt_not_empty:
              config:
                name: feat_h3_poi_points_r10__cell_center_wkt_not_empty
          - wkt_prefix_any:
              arguments:
                prefixes: ["POINT"]
              config:
                name: feat_h3_poi_points_r10__cell_center_wkt_prefix_point

      - name: poi_points_cnt
        description: "Total number of POI points inside the H3 cell."
        tests:
          - not_null
          - non_negative:
              config:
                name: feat_h3_poi_points_r10__poi_points_cnt_non_negative

      - name: poi_classes_cnt
        description: "Count of distinct poi_class values in the cell."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_points_r10__poi_classes_cnt_non_negative

      - name: poi_types_cnt
        description: "Count of distinct poi_type values in the cell."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_points_r10__poi_types_cnt_non_negative

      # class breakdown counts
      - name: amenity_cnt
        description: "Count of POI points where poi_class = amenity."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_points_r10__amenity_cnt_non_negative

      - name: shop_cnt
        description: "Count of POI points where poi_class = shop."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_points_r10__shop_cnt_non_negative

      - name: tourism_cnt
        description: "Count of POI points where poi_class = tourism."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_points_r10__tourism_cnt_non_negative

      - name: leisure_cnt
        description: "Count of POI points where poi_class = leisure."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_points_r10__leisure_cnt_non_negative

      - name: office_cnt
        description: "Count of POI points where poi_class = office."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_points_r10__office_cnt_non_negative

      - name: craft_cnt
        description: "Count of POI points where poi_class = craft."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_points_r10__craft_cnt_non_negative

      - name: man_made_cnt
        description: "Count of POI points where poi_class = man_made."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_points_r10__man_made_cnt_non_negative

      - name: emergency_cnt
        description: "Count of POI points where poi_class = emergency."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_points_r10__emergency_cnt_non_negative

      - name: public_transport_cnt
        description: "Count of POI points where poi_class = public_transport."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_points_r10__public_transport_cnt_non_negative

      - name: railway_cnt
        description: "Count of POI points where poi_class = railway."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_points_r10__railway_cnt_non_negative

      - name: highway_cnt
        description: "Count of POI points where poi_class = highway."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_points_r10__highway_cnt_non_negative

      - name: place_cnt
        description: "Count of POI points where poi_class = place."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_points_r10__place_cnt_non_negative

      # EV-relevant landmark counters
      - name: parking_cnt
        description: "Count of POI points related to parking (parking, parking_entrance, bicycle_parking)."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_points_r10__parking_cnt_non_negative

      - name: mobility_services_cnt
        description: "Count of mobility-related services (fuel/charging_station/car_wash/etc.)."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_points_r10__mobility_services_cnt_non_negative

      - name: retail_core_cnt
        description: "Count of core retail anchors (supermarket/mall/etc.)."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_points_r10__retail_core_cnt_non_negative

      - name: food_cnt
        description: "Count of food & beverage POIs (restaurant/fast_food/cafe/bar/pub)."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_points_r10__food_cnt_non_negative

      - name: lodging_cnt
        description: "Count of lodging POIs (hotel/motel/hostel/guest_house/apartments)."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_points_r10__lodging_cnt_non_negative

      - name: health_cnt
        description: "Count of health-related POIs (hospital/clinic/doctors/pharmacy)."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_points_r10__health_cnt_non_negative

      # densities
      - name: poi_points_per_km2
        description: "POI points density per km² (poi_points_cnt normalized by H3 cell area)."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_points_r10__poi_points_per_km2_non_negative

      - name: amenity_per_km2
        description: "Amenity POI density per km²."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_points_r10__amenity_per_km2_non_negative

      - name: shop_per_km2
        description: "Shop POI density per km²."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_points_r10__shop_per_km2_non_negative

      - name: parking_per_km2
        description: "Parking POI density per km²."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_points_r10__parking_per_km2_non_negative