version: 2

models:
  - name: feat_h3_poi_areas_r7__centroid_xarea
    description: >
      GOLD.FEAT_H3_POI_AREAS_R7__CENTROID_XAREA — POI polygon features on H3 r7 grid.
      Method: centroid -> h3_r7 candidate cell, then exact intersection area within that cell.

      Grain: (region_code, h3_r7) — covered cells only.

    tests:
      - rowcount_gt_0:
          config: {name: feat_h3_poi_areas_r7__centroid_xarea__rowcount_gt_0}

      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: [region_code, h3_r7]
          config: {name: feat_h3_poi_areas_r7__centroid_xarea__uk_region_h3}

      - dbt_utils.expression_is_true:
          arguments:
            expression: "poi_area_share is null or poi_area_share <= 5"
          config:
            name: feat_h3_poi_areas_r7__centroid_xarea__poi_area_share_le_5
            severity: warn
            warn_if: "> 0"
            error_if: ">= 1000"

    columns:
      - name: region_code
        tests: [not_null]

      - name: h3_r7
        tests:
          - not_null
          - is_h3_hex:
              config: {name: feat_h3_poi_areas_r7__centroid_xarea__h3_is_hex}

      - name: cell_area_m2
        tests:
          - not_null
          - non_negative:
              config: {name: feat_h3_poi_areas_r7__centroid_xarea__cell_area_non_negative}

      - name: cell_wkt_4326
        tests:
          - not_null
          - wkt_not_empty:
              arguments: {column_name: cell_wkt_4326}
              config: {name: feat_h3_poi_areas_r7__centroid_xarea__cell_wkt_not_empty}
          - wkt_prefix_any:
              arguments:
                column_name: cell_wkt_4326
                prefixes: ["POLYGON","MULTIPOLYGON"]
              config: {name: feat_h3_poi_areas_r7__centroid_xarea__cell_wkt_prefix_polygon}

      - name: cell_center_wkt_4326
        tests:
          - not_null
          - wkt_not_empty:
              arguments: {column_name: cell_center_wkt_4326}
              config: {name: feat_h3_poi_areas_r7__centroid_xarea__center_wkt_not_empty}
          - wkt_prefix_any:
              arguments:
                column_name: cell_center_wkt_4326
                prefixes: ["POINT"]
              config: {name: feat_h3_poi_areas_r7__centroid_xarea__center_wkt_prefix_point}

      - name: poi_areas_cnt
        tests:
          - not_null
          - non_negative:
              config: {name: feat_h3_poi_areas_r7__centroid_xarea__poi_areas_cnt_non_negative}

      - name: poi_area_m2_sum
        tests:
          - non_negative:
              config: {name: feat_h3_poi_areas_r7__centroid_xarea__poi_area_m2_sum_non_negative}

      - name: poi_area_share
        tests:
          - non_negative:
              config: {name: feat_h3_poi_areas_r7__centroid_xarea__poi_area_share_non_negative}

      - name: poi_areas_per_km2
        tests:
          - non_negative:
              config: {name: feat_h3_poi_areas_r7__centroid_xarea__poi_areas_per_km2_non_negative}

      - name: poi_area_m2_per_km2
        tests:
          - non_negative:
              config: {name: feat_h3_poi_areas_r7__centroid_xarea__poi_area_m2_per_km2_non_negative}

      - name: last_load_ts
        tests: [not_null]