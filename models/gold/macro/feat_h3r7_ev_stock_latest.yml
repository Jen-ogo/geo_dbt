version: 2

models:
  - name: feat_h3r7_ev_stock_latest
    description: >
      H3 R7 feature mart enriched with Eurostat EV stock metrics at NUTS2 level (latest year).
      Project scope is derived via spatial relationship:
      admin_areas (admin_level=4) defines project regions; NUTS2 polygons are selected by centroid-in-admin,
      then each H3 cell is mapped by its cell center to NUTS2 and receives latest EV metrics.

      Region is currently nullable/derived from scope because DIM does not contain region.

      Grain: (region_code, h3_r7).

    tests:
      - rowcount_gt_0:
          config: {name: feat_h3r7_ev_stock_latest__rowcount_gt_0}
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: [region_code, h3_r7]
          config: {name: feat_h3r7_ev_stock_latest__uk_region_h3}

    columns:
      - name: region_code
        tests: [not_null]

      - name: region
        description: "Derived from admin scope; nullable until DIM has region."

      - name: h3_r7
        tests:
          - not_null
          - is_h3_hex:
              config: {name: feat_h3r7_ev_stock_latest__h3_is_hex}

      - name: cell_area_m2
        tests:
          - not_null
          - non_negative:
              config: {name: feat_h3r7_ev_stock_latest__cell_area_non_negative}

      - name: cell_wkt_4326
        tests:
          - not_null
          - wkt_not_empty:
              config: {name: feat_h3r7_ev_stock_latest__cell_wkt_not_empty}
          - wkt_prefix_any:
              arguments:
                prefixes: ["POLYGON","MULTIPOLYGON"]
              config: {name: feat_h3r7_ev_stock_latest__cell_wkt_prefix_polygonal}

      - name: cell_center_wkt_4326
        tests:
          - not_null
          - wkt_not_empty:
              config: {name: feat_h3r7_ev_stock_latest__cell_center_wkt_not_empty}
          - wkt_prefix_any:
              arguments:
                prefixes: ["POINT"]
              config: {name: feat_h3r7_ev_stock_latest__cell_center_wkt_prefix_point}

      - name: cntr_code
        tests: [not_null]
      - name: nuts_id
        tests: [not_null]
      - name: nuts_level
        tests:
          - values_in_or_null:
              arguments: {column_name: nuts_level, values: [2]}
              config: {name: feat_h3r7_ev_stock_latest__nuts_level_is_2}
      - name: nuts_name
        tests: [not_null]
      - name: nuts_wkt_4326
        tests:
          - not_null
          - wkt_not_empty:
              config: {name: feat_h3r7_ev_stock_latest__nuts_wkt_not_empty}
          - wkt_prefix_any:
              arguments:
                prefixes: ["POLYGON","MULTIPOLYGON"]
              config: {name: feat_h3r7_ev_stock_latest__nuts_wkt_prefix_polygonal}

      - name: car_year_latest
        tests: [not_null]

      - name: car_ev_nr_latest
        tests: [not_null, non_negative]
      - name: car_ev_pc_latest
        tests: [not_null, non_negative]
      - name: vg_le3p5_ev_nr_latest
        tests: [not_null, non_negative]
      - name: vg_le3p5_ev_pc_latest
        tests: [not_null, non_negative]
      - name: bus_ev_nr_latest
        tests: [not_null, non_negative]
      - name: bus_ev_pc_latest
        tests: [not_null, non_negative]