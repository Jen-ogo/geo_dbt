version: 2

models:
  - name: feat_h3_buildings_r10
    description: >
      H3 R10 buildings feature mart.
      Aggregates OSM building polygons from SILVER.ACTIVITY_PLACES (activity_class='building')
      to the H3 resolution 10 grid. Provides counts, area sums, robust percentiles, and
      normalized density metrics per km², plus a built-up share metric (footprint area / cell area).

      Grain: (region_code, h3_r10) — exactly one row per H3 cell per region_code.
      Notes:
      - building_levels defaults to 1 when missing/invalid (conservative).
      - building_group is a simplified mapping of building_type into: residential / nonresidential / unknown / other.
      - built_up_share is expected to be <= 1 in ideal data; may exceed due to overlaps/invalid geometries.
        We keep it but monitor via a configurable sanity test (warn vs error thresholds).

    tests:
      - rowcount_gt_0:
          name: feat_h3_buildings_r10__rowcount_gt_0

      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: [region_code, h3_r10]
          config:
            name: feat_h3_buildings_r10__uk_region_h3

      # Regulated strictness: warn on any outliers; fail build only if explosion (>=1000 rows).
      - dbt_utils.expression_is_true:
          arguments:
            expression: "built_up_share is null or built_up_share <= 5"
          config:
            name: feat_h3_buildings_r10__built_up_share_le_5_warn
            severity: error
            warn_if: "> 0"
            error_if: ">= 1000"

    columns:
      - name: region_code
        description: "Region/country code propagated from SILVER.activity_places."
        tests:
          - not_null

      - name: h3_r10
        description: "H3 cell index at resolution 10."
        tests:
          - not_null
          - is_h3_hex:
              name: feat_h3_buildings_r10__h3_r10_is_hex

      - name: cell_area_m2
        description: "Area of the H3 cell polygon (m²)."
        tests:
          - not_null
          - non_negative:
              name: feat_h3_buildings_r10__cell_area_m2_non_negative

      - name: cell_wkt_4326
        description: "H3 cell boundary as WKT POLYGON (debug/inspection)."
        tests:
          - not_null
          - wkt_not_empty:
              name: feat_h3_buildings_r10__cell_wkt_not_empty
          - wkt_prefix_any:
              prefixes: ['POLYGON', 'MULTIPOLYGON']
              name: feat_h3_buildings_r10__cell_wkt_prefix_polygon

      - name: cell_center_wkt_4326
        description: "H3 cell center point as WKT POINT (debug/inspection)."
        tests:
          - not_null
          - wkt_not_empty:
              name: feat_h3_buildings_r10__cell_center_wkt_not_empty
          - wkt_prefix_any:
              prefixes: ['POINT']
              name: feat_h3_buildings_r10__cell_center_wkt_prefix_point

      - name: buildings_cnt
        description: "Total buildings count in the cell."
        tests:
          - not_null
          - non_negative:
              name: feat_h3_buildings_r10__buildings_cnt_non_negative

      - name: res_buildings_cnt
        description: "Count of residential buildings in the cell."
        tests:
          - non_negative:
              name: feat_h3_buildings_r10__res_buildings_cnt_non_negative

      - name: nonres_buildings_cnt
        description: "Count of non-residential buildings in the cell."
        tests:
          - non_negative:
              name: feat_h3_buildings_r10__nonres_buildings_cnt_non_negative

      - name: unknown_buildings_cnt
        description: "Count where building_type was 'yes' (treated as unknown)."
        tests:
          - non_negative:
              name: feat_h3_buildings_r10__unknown_buildings_cnt_non_negative

      - name: footprint_area_m2_sum
        description: "Sum of building footprint areas (m²) within the cell."
        tests:
          - non_negative:
              name: feat_h3_buildings_r10__footprint_area_m2_sum_non_negative

      - name: floor_area_m2_est_sum
        description: >
          Estimated floor area sum (m²) as footprint_area_m2 * building_levels (levels default to 1).
          This is a heuristic proxy for built intensity.
        tests:
          - non_negative:
              name: feat_h3_buildings_r10__floor_area_m2_est_sum_non_negative

      - name: levels_avg
        description: "Average building levels in the cell."
        tests:
          - non_negative:
              name: feat_h3_buildings_r10__levels_avg_non_negative

      - name: levels_p50
        description: "Median (p50) building levels in the cell (approx)."
        tests:
          - non_negative:
              name: feat_h3_buildings_r10__levels_p50_non_negative

      - name: footprint_area_p50_m2
        description: "Median (p50) footprint area in the cell (approx, m²)."
        tests:
          - non_negative:
              name: feat_h3_buildings_r10__footprint_area_p50_non_negative

      - name: footprint_area_p90_m2
        description: "90th percentile footprint area in the cell (approx, m²)."
        tests:
          - non_negative:
              name: feat_h3_buildings_r10__footprint_area_p90_non_negative

      - name: buildings_per_km2
        description: "Buildings density per km² (buildings_cnt normalized by cell area)."
        tests:
          - non_negative:
              name: feat_h3_buildings_r10__buildings_per_km2_non_negative

      - name: footprint_m2_per_km2
        description: "Footprint area density per km²."
        tests:
          - non_negative:
              name: feat_h3_buildings_r10__footprint_m2_per_km2_non_negative

      - name: floor_area_m2_per_km2
        description: "Estimated floor area density per km²."
        tests:
          - non_negative:
              name: feat_h3_buildings_r10__floor_area_m2_per_km2_non_negative

      - name: built_up_share
        description: >
          Share of cell area covered by building footprints:
          footprint_area_m2_sum / cell_area_m2.
          Ideal range: 0..1, but may exceed due to overlaps/invalid input geometries; monitored by sanity test.

      - name: last_load_ts
        description: "Latest load timestamp among contributing activity places."
        tests:
          - not_null