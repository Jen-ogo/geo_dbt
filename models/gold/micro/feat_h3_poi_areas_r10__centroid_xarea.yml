version: 2

models:
  - name: feat_h3_poi_areas_r10__centroid_xarea
    description: >
      GOLD.FEAT_H3_POI_AREAS_R10__CENTROID_XAREA — POI polygon features on H3 r10 grid.
      Source
      - SILVER.POI_AREAS: canonical POI polygons (GEOGRAPHY), deduplicated by feature_id
      - SILVER.DIM_H3_R10_CELLS: canonical H3 cell geometry + area + WKT debug columns

      Method (CENTROID_XAREA)
      - Candidate H3 cell is derived from polygon centroid (fast).
      - Exact area within the H3 cell is computed via intersection:
        `ST_AREA(ST_INTERSECTION(poi_geog, cell_geog))`.
      - Aggregation is per (region_code, h3_r10).

      Grain
      - (region_code, h3_r10) — 1 row per H3 cell per region_code.

      Limitations
      - This is not polyfill. Large polygons spanning many cells will be under-represented
        (only the centroid cell gets attributed). This is intended as an ML-friendly, cost-efficient feature mart.

      Data quality
      - Structural constraints are strict (keys, H3 format, cell areas).
      - Overlap-driven anomalies (poi_area_share > 1) are monitored with warn/error thresholds.

    tests:
      - rowcount_gt_0:
          config:
            name: feat_h3_poi_areas_r10__centroid_xarea__rowcount_gt_0

      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: [region_code, h3_r10]
          config:
            name: feat_h3_poi_areas_r10__centroid_xarea__uk_region_h3

      # monitor overlap explosions (warn on any, error only if massive)
      - dbt_utils.expression_is_true:
          arguments:
            expression: "poi_area_share is null or poi_area_share <= 5"
          config:
            name: feat_h3_poi_areas_r10__centroid_xarea__poi_area_share_le_5
            severity: warn
            warn_if: "> 0"
            error_if: ">= 1000"

    columns:
      - name: region_code
        description: "Region/country code (e.g. poland, germany)."
        tests: [not_null]

      - name: h3_r10
        description: "H3 cell index at resolution 10."
        tests:
          - not_null
          - is_h3_hex:
              config:
                name: feat_h3_poi_areas_r10__centroid_xarea__h3_r10_is_hex

      - name: cell_area_m2
        description: "Area of the H3 cell polygon (m²)."
        tests:
          - not_null
          - num_gt_0:
              config:
                name: feat_h3_poi_areas_r10__centroid_xarea__cell_area_m2_gt_0

      - name: cell_wkt_4326
        description: "H3 cell boundary WKT (debug)."
        tests:
          - not_null
          - wkt_not_empty:
              config:
                name: feat_h3_poi_areas_r10__centroid_xarea__cell_wkt_not_empty
          - wkt_prefix_any:
              arguments:
                prefixes: ["POLYGON(", "MULTIPOLYGON("]
              config:
                name: feat_h3_poi_areas_r10__centroid_xarea__cell_wkt_prefix_polygonal

      - name: cell_center_wkt_4326
        description: "H3 cell center WKT (debug)."
        tests:
          - not_null
          - wkt_not_empty:
              config:
                name: feat_h3_poi_areas_r10__centroid_xarea__cell_center_wkt_not_empty
          - wkt_prefix_any:
              arguments:
                prefixes: ["POINT("]
              config:
                name: feat_h3_poi_areas_r10__centroid_xarea__cell_center_wkt_prefix_point

      - name: poi_areas_cnt
        description: "Distinct POI polygon count attributed to the cell (centroid candidate)."
        tests:
          - not_null
          - non_negative:
              config:
                name: feat_h3_poi_areas_r10__centroid_xarea__poi_areas_cnt_non_negative

      - name: poi_area_m2_sum
        description: "Sum of intersection areas (m²) of POI polygons within the H3 cell."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_areas_r10__centroid_xarea__poi_area_m2_sum_non_negative

      - name: poi_area_share
        description: >
          Share of H3 cell area covered by POI polygons:
          poi_area_m2_sum / cell_area_m2.
          May exceed 1 due to overlaps; monitored by sanity test.
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_areas_r10__centroid_xarea__poi_area_share_non_negative

      - name: poi_areas_per_km2
        description: "POI polygon density per km²."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_areas_r10__centroid_xarea__poi_areas_per_km2_non_negative

      - name: poi_area_m2_per_km2
        description: "POI area density (m²) per km² of H3 cell."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_areas_r10__centroid_xarea__poi_area_m2_per_km2_non_negative

      - name: amenity_areas_cnt
        description: "POI polygons count (amenity class)."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_areas_r10__centroid_xarea__amenity_areas_cnt_non_negative

      - name: shop_areas_cnt
        description: "POI polygons count (shop class)."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_areas_r10__centroid_xarea__shop_areas_cnt_non_negative

      - name: tourism_areas_cnt
        description: "POI polygons count (tourism class)."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_areas_r10__centroid_xarea__tourism_areas_cnt_non_negative

      - name: office_areas_cnt
        description: "POI polygons count (office class)."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_areas_r10__centroid_xarea__office_areas_cnt_non_negative

      - name: leisure_areas_cnt
        description: "POI polygons count (leisure class)."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_areas_r10__centroid_xarea__leisure_areas_cnt_non_negative

      - name: sport_areas_cnt
        description: "POI polygons count (sport class)."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_areas_r10__centroid_xarea__sport_areas_cnt_non_negative

      - name: building_areas_cnt
        description: "POI polygons count (building class)."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_areas_r10__centroid_xarea__building_areas_cnt_non_negative

      - name: landuse_areas_cnt
        description: "POI polygons count (landuse class)."
        tests:
          - non_negative:
              config:
                name: feat_h3_poi_areas_r10__centroid_xarea__landuse_areas_cnt_non_negative

      - name: last_load_ts
        description: "Latest load timestamp among contributing POI polygons."
        tests: [not_null]